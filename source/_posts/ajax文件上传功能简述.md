---
title: ajax文件上传功能简述
date: 2016-11-14 18:57:34
tags: javascript
categories: 技术
---
> 回忆就好像缓存，不清一清，怎么能看到未来。

**最**近几天一直在忙着搞个视频上传功能，本来想想比较简单，无非就是前端上传，服务端做处理，返回状态。可是偏偏要集成在百度的ueditor中，方便我们运营人员使用，于是问题就变得恶心了。最初当然是看相关的api文档，然后就按着流程走了一下，结果发现，之前维护编辑器的小伙伴貌似没按套路来，配置走了其他方式，然后我就想哭了。经过两天的苦战之后，摸到门路，终于把视频上传功能的套子给建设好了，然后就开开心心的搞功能了，接下来就谈谈上传所涉及的前端技术。
**先**来简单扯扯以前的上传文件方式（flash插件之类的我就不提了，毕竟这种高级货对于前端来说会用就行了，别太执着怎么实现的）。<!--more-->基本大都是通过form表单来完成，但是页面会刷新，这种体验感给人感觉很不友好，然后就有人通过隐藏的iframe来完成表单提交，就实现了无刷新的上传功能，体验度得到了直线上升，但是通过iframe来完成无刷新上传始终给人感觉太过于繁琐，不太直观，毕竟我们习惯了用ajax与服务端来交互，一直想着能用ajax来完成表单的提交功能，但是在几年前（具体几年我真不知道，我入前端也就两年0.0），这个是没法实现的，因为老的ajax技术中XMLHttpRequest对象有一些缺陷：
> * 只支持文本数据的传送，不支持二进制文件的上传。
> * 不支持跨域

然后在新版本中做了好多改进，其中两条那肯定是对上面那两个缺陷修复了，即支持了二进制文件的上传，支持了跨域，支持了进度更新，其他的就不说了，自行百度。
既然支持了二进制文件上传，那我们的文件上传功能在现代浏览器中就可以使用熟悉的ajax配合h5的FormData对象来完成，FormData 可以模拟表单数据，以键值存储数据。然后那些年让人头痛的上传功能就可以简化为一下代码：

    var data = new FormData(form/null);//可以是表单对象，或者为空，后边自己添加数据。
    $.ajax({ 
	    url: 'http://minisky.duapp.com/upload',//接口 
	    type: 'POST',  
	    data: data,   
	    processData: false,  //告诉jquery对象处理你要发送的数据
	    contentType: false, //告诉jquery不要去给别人乱加请求头类型
	    success:function(res){
	    	//to do
	    },
	    xhr: function(){
	        var xhr = $.ajaxSettings.xhr();//得到xhr对象
	            if(xhr.upload) {
	                xhr.upload.addEventListener("progress" , function(evt){
	                //evt.loaded,evt.total
	                },false);
	                return xhr;
	            }
	    },
        error:function(){
            //....
        }
    });

上面基本算是一个完整的ajax文件上传代码。自己当时再做上传功能时临时做了个测试**[demo](http://minisky.duapp.com/skyexample/upload):**http://minisky.duapp.com/skyexample/upload 由于仅仅是测试，代码未做优化，比较丑。当然，如果不太喜欢jquery的可以用原生的ajax来完成，代码比较简单整洁，该demo代码中也有相应例子，不过不完整，也不多说，可以自由发挥。
到这里，或许会发现，跨域了怎么办，上面代码并没有做跨域相关的解释。首先我们要知道，跨域受两方面限制，一方面来自浏览器，一方面来自服务端，既然我们都在用现代浏览器了，那么自然浏览器允许你跨域了，支持你跨域的这个需求，那么接下来就是服务端是否支持了，如果有一天你遇到出现跨域限制问题，就不要为难自己了，大胆的去跟服务端同学说下，你这边需要设置一下允许跨域的头，类似这样：

    res.header("Access-Control-Allow-Origin", "*");//*指的是允许任何网站跨域请求，你可以指定你所在一个或者几个域。
    
上面是nodejs设置方式，不过无论是哪种，基本都是大同小异。然后通过这两方面的支持，你就可以实现跨域上传，跨域请求等，不用在为跨域那么苦恼，demo中接口支持跨域的，你也可以在本地调用试试。
噢，忘了说IE,IE10以下，建议还是用传统的表单方式吧，虽然没有测过，但是好像不行，如果遇到，请谨慎用此方法。以上都是个人粗浅的认识以及蹩脚的解决方案，如果有讲错或者没讲清楚的地方，欢迎留言交流。